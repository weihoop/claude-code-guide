---
name: review
description: 完整的代码审查流程
aliases: [cr, code-review, inspect]
---

# 代码审查流程

专业的代码审查工具，全面检查代码质量、安全性和最佳实践。

## 执行步骤

### 1. 确定审查目标

询问用户要审查的文件，或者自动检测最近修改的文件：
```bash
git diff --name-only HEAD~1
```

如果用户没有指定，列出候选文件供选择。

### 2. 读取文件内容

使用 Read 工具读取目标文件的完整内容。

### 3. 执行多维度审查

#### 📝 代码质量检查

**命名规范**
- [ ] 变量名是否清晰、有意义
- [ ] 函数名是否描述其功能
- [ ] 类名是否符合命名约定
- [ ] 常量是否使用大写

**代码结构**
- [ ] 函数是否遵循单一职责原则
- [ ] 代码是否有适当的抽象
- [ ] 是否避免代码重复（DRY 原则）
- [ ] 代码层次是否清晰

**可读性**
- [ ] 代码逻辑是否易于理解
- [ ] 是否有必要的注释
- [ ] 复杂逻辑是否有说明
- [ ] 代码格式是否统一

#### ⚠️ 潜在问题检查

**常见错误**
- [ ] 空指针/未定义引用
- [ ] 数组越界
- [ ] 类型不匹配
- [ ] 资源未释放（文件、连接等）
- [ ] 无限循环风险

**边界条件**
- [ ] 是否处理空值/null
- [ ] 是否处理空数组/空字符串
- [ ] 是否处理边界值（0, -1, 最大值等）
- [ ] 是否处理异常输入

**性能问题**
- [ ] 是否有 N+1 查询
- [ ] 是否有不必要的循环嵌套
- [ ] 是否有重复计算
- [ ] 数据结构选择是否合理

#### 🔒 安全性检查

**常见漏洞**
- [ ] SQL 注入风险
- [ ] XSS 跨站脚本攻击
- [ ] CSRF 跨站请求伪造
- [ ] 路径遍历漏洞
- [ ] 命令注入风险

**敏感信息**
- [ ] 是否硬编码密码/密钥
- [ ] 是否暴露敏感数据
- [ ] 是否记录敏感信息到日志
- [ ] 是否使用不安全的加密

**权限和验证**
- [ ] 是否验证用户输入
- [ ] 是否检查权限
- [ ] 是否使用安全的会话管理
- [ ] 是否正确处理认证

#### ✅ 最佳实践检查

**错误处理**
- [ ] 是否有适当的异常处理
- [ ] 错误信息是否有意义
- [ ] 是否记录错误日志
- [ ] 是否优雅地处理失败情况

**测试覆盖**
- [ ] 是否有相应的单元测试
- [ ] 关键逻辑是否有测试覆盖
- [ ] 是否有边界值测试

**文档和注释**
- [ ] 公共 API 是否有文档注释
- [ ] 复杂算法是否有说明
- [ ] 配置是否有注释
- [ ] README 是否需要更新

**项目规范**
- [ ] 是否符合团队编码规范
- [ ] 是否遵循项目架构设计
- [ ] 依赖引入是否合理
- [ ] 是否符合版本控制规范

### 4. 生成审查报告

以 Markdown 格式输出完整的审查报告：

```markdown
## 代码审查报告

**文件**: `src/api/auth.js`
**审查时间**: 2025-11-30
**审查者**: Claude Code

---

### ✅ 优点

1. **代码结构清晰**
   - 函数职责单一，易于维护
   - 模块化设计良好

2. **错误处理完善**
   - 所有异步操作都有 try-catch
   - 错误信息详细明确

3. **命名规范**
   - 变量和函数命名清晰易懂
   - 遵循驼峰命名约定

---

### ⚠️ 发现的问题

#### 高危问题

1. **SQL 注入风险** (行 45-48)
   ```javascript
   // 问题代码
   const query = `SELECT * FROM users WHERE id = ${userId}`;
   ```
   **建议**: 使用参数化查询
   ```javascript
   const query = 'SELECT * FROM users WHERE id = ?';
   db.query(query, [userId]);
   ```

2. **硬编码密钥** (行 12)
   ```javascript
   const SECRET_KEY = 'my-secret-key-123';
   ```
   **建议**: 使用环境变量
   ```javascript
   const SECRET_KEY = process.env.JWT_SECRET;
   ```

#### 中危问题

1. **缺少空值检查** (行 67)
   ```javascript
   const username = user.profile.name;  // user.profile 可能为 null
   ```
   **建议**: 添加空值检查
   ```javascript
   const username = user?.profile?.name || 'Anonymous';
   ```

2. **性能问题** (行 89-95)
   - 在循环中进行数据库查询（N+1 问题）
   **建议**: 使用批量查询或 JOIN

#### 低危问题

1. **注释不足** (行 120-135)
   - 复杂的算法逻辑缺少注释说明

2. **变量命名** (行 78)
   ```javascript
   const d = new Date();  // 命名过于简单
   ```
   **建议**: 使用更具描述性的名称

---

### 💡 改进建议

1. **安全性提升**
   - 所有用户输入都应进行验证和清理
   - 使用环境变量存储敏感配置
   - 添加请求限流防止暴力破解

2. **性能优化**
   - 优化数据库查询，减少 N+1 问题
   - 添加缓存层减少重复查询
   - 考虑使用连接池

3. **代码健壮性**
   - 增加边界条件处理
   - 完善错误处理和日志记录
   - 添加输入验证

4. **可维护性**
   - 为复杂逻辑添加注释
   - 提取魔法数字为常量
   - 考虑拆分过长的函数

---

### 📊 统计信息

- **总行数**: 256
- **高危问题**: 2 个
- **中危问题**: 2 个
- **低危问题**: 2 个
- **建议改进**: 4 项

---

### 🎯 下一步行动

1. 立即修复高危安全问题
2. 优化性能问题
3. 完善测试覆盖
4. 更新相关文档
```

### 5. 运行相关测试

如果存在测试文件，运行相关测试：
```bash
npm test -- auth.test.js
```

### 6. 提供修复建议

对于发现的问题，提供具体的修复代码示例。

## 审查级别

可以根据需要选择不同的审查深度：

### 快速审查（Quick Review）
- 基础代码质量
- 明显的语法错误
- 简单的安全问题

### 标准审查（Standard Review）
- 完整的代码质量检查
- 安全性检查
- 最佳实践验证

### 深度审查（Deep Review）
- 全面的多维度检查
- 性能分析
- 架构设计评估
- 安全深度扫描

## 特定语言的审查重点

### JavaScript/TypeScript
- 类型安全（TypeScript）
- Promise 错误处理
- 闭包和作用域
- 异步操作

### Python
- PEP 8 规范
- 异常处理
- 资源管理（with 语句）
- 类型提示

### Go
- 错误处理
- goroutine 和 channel
- 资源清理（defer）
- 接口设计

### Java
- 异常处理
- 资源管理（try-with-resources）
- 线程安全
- 设计模式应用

## 使用示例

```
用户: /review src/api/auth.js

Claude: 我来审查 src/api/auth.js 文件...

[执行完整审查流程]

Claude: 审查完成！发现 2 个高危问题，4 个中危问题。
       建议优先修复 SQL 注入和硬编码密钥问题。
```
